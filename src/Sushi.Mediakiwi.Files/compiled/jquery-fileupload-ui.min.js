!function(a){"use strict";a.widget("blueimpUI.fileupload",a.blueimp.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplate:a("#template-upload"),downloadTemplate:a("#template-download"),dataType:"json",add:function(b,c){var d=a(this).data("fileupload");d._adjustMaxNumberOfFiles(-c.files.length),c.isAdjusted=!0,c.isValidated=d._validate(c.files),c.context=d._renderUpload(c.files).appendTo(a(this).find(".files")).show().data("data",c),(d.options.autoUpload||c.autoUpload)&&c.isValidated&&(c.jqXHR=c.submit())},send:function(b,c){if(!c.isValidated){var d=a(this).data("fileupload");if(c.isAdjusted||d._adjustMaxNumberOfFiles(-c.files.length),!d._validate(c.files))return!1}c.context&&c.dataType&&"iframe"===c.dataType.substr(0,6)&&c.context.find(".ui-progressbar").progressbar("value",parseInt(100,10))},done:function(b,c){var d=a(this).data("fileupload");c.context?c.context.each(function(b){var e=a.isArray(c.result)&&c.result[b]||{error:"emptyResult"},f=a("#assets").val();""!=f&&(f+=","),f+=c.result.files[0].ID,a("#assets").val(f),e.error&&d._adjustMaxNumberOfFiles(1),a(this).fadeOut(function(){d._renderDownload([e]).css("display","none").replaceAll(this)})}):d._renderDownload(c.result).css("display","none").appendTo(a(this).find(".files")).fadeIn(function(){a(this).show()})},fail:function(b,c){var d=a(this).data("fileupload");d._adjustMaxNumberOfFiles(c.files.length),c.context?c.context.each(function(b){a(this).fadeOut(function(){if("abort"!==c.errorThrown){var e=c.files[b];e.error=e.error||c.errorThrown||!0,d._renderDownload([e]).css("display","none").replaceAll(this).fadeIn(function(){a(this).show()})}else c.context.remove()})}):"abort"!==c.errorThrown&&(d._adjustMaxNumberOfFiles(-c.files.length),c.context=d._renderUpload(c.files).css("display","none").appendTo(a(this).find(".files")).fadeIn(function(){a(this).show()}).data("data",c))},progress:function(a,b){b.context&&b.context.find(".ui-progressbar").progressbar("value",parseInt(b.loaded/b.total*100,10))},progressall:function(b,c){a(this).find(".fileupload-progressbar").progressbar("value",parseInt(c.loaded/c.total*100,10))},start:function(){a(this).find(".fileupload-progressbar").progressbar("value",0),a("div#loader").fadeIn(3e3)},stop:function(){a(this).find(".fileupload-progressbar");var b=location.href+="&col="+a("#assets").val();location.replace(b)},destroy:function(b,c){var d=a(this).data("fileupload");c.url?a.ajax(c).success(function(){d._adjustMaxNumberOfFiles(1),a(this).fadeOut(function(){a(this).remove()})}):c.context.fadeOut(function(){a(this).remove()})}},_scaleImage:function(a,b){b=b||{};var c=document.createElement("canvas"),d=Math.min((b.maxWidth||a.width)/a.width,(b.maxHeight||a.height)/a.height);return d>=1&&(d=Math.max((b.minWidth||a.width)/a.width,(b.minHeight||a.height)/a.height)),a.width=parseInt(a.width*d,10),a.height=parseInt(a.height*d,10),b.canvas&&c.getContext?(c.width=a.width,c.height=a.height,c.getContext("2d").drawImage(a,0,0,a.width,a.height),c):a},_createObjectURL:function(a){var b="undefined",c=typeof window.createObjectURL!==b&&window||typeof URL!==b&&URL||typeof webkitURL!==b&&webkitURL;return!!c&&c.createObjectURL(a)},_revokeObjectURL:function(a){var b="undefined",c=typeof window.revokeObjectURL!==b&&window||typeof URL!==b&&URL||typeof webkitURL!==b&&webkitURL;return!!c&&c.revokeObjectURL(a)},_loadFile:function(a,b){if("undefined"!=typeof FileReader&&FileReader.prototype.readAsDataURL){var c=new FileReader;return c.onload=function(a){b(a.target.result)},c.readAsDataURL(a),!0}return!1},_loadImage:function(b,c,d){var e,f,g=this;d&&d.fileTypes&&!d.fileTypes.test(b.type)||(e=this._createObjectURL(b),f=a("<img>").bind("load",function(){a(this).unbind("load"),g._revokeObjectURL(e),c(g._scaleImage(f[0],d))}).prop("src",e),e||this._loadFile(b,function(a){f.prop("src",a)}))},_enableDragToDesktop:function(){var b=a(this),c=b.prop("href"),d=decodeURIComponent(c.split("/").pop()).replace(/:/g,"-");b.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",d,c].join(":"))}catch(b){}})},_adjustMaxNumberOfFiles:function(a){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=a,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(a){return"number"!=typeof a.size?"":a.size>=1e9?(a.size/1e9).toFixed(2)+" GB":a.size>=1e6?(a.size/1e6).toFixed(2)+" MB":(a.size/1e3).toFixed(2)+" KB"},_hasError:function(a){return a.error?a.error:this.options.maxNumberOfFiles<0?"maxNumberOfFiles":this.options.acceptFileTypes.test(a.type)||this.options.acceptFileTypes.test(a.name)?this.options.maxFileSize&&a.size>this.options.maxFileSize?"maxFileSize":"number"==typeof a.size&&a.size<this.options.minFileSize?"minFileSize":null:"acceptFileTypes"},_validate:function(b){var c,d=this;return a.each(b,function(a,b){b.error=d._hasError(b),c=!b.error}),c},_uploadTemplateHelper:function(a){return a.sizef=this._formatFileSize(a),a},_renderUploadTemplate:function(b){var c=this;return a.tmpl(this.options.uploadTemplate,a.map(b,function(a){return c._uploadTemplateHelper(a)}))},_renderUpload:function(b){var c=this,d=this.options,e=this._renderUploadTemplate(b);return e instanceof a?(e.css("display","none"),e.find(".progress div").slice(1).remove().end().first().progressbar(),e.find(".start button").slice(this.options.autoUpload?0:1).remove().end().first().button({text:!1,icons:{primary:"ui-icon-circle-arrow-e"}}),e.find(".cancel button").slice(1).remove().end().first().button({text:!1,icons:{primary:"ui-icon-cancel"}}),e.find(".preview").each(function(e,f){c._loadImage(b[e],function(b){a(b).hide().appendTo(f).fadeIn()},{maxWidth:d.previewMaxWidth,maxHeight:d.previewMaxHeight,fileTypes:d.previewFileTypes,canvas:d.previewAsCanvas})}),e):a()},_downloadTemplateHelper:function(a){return a.sizef=this._formatFileSize(a),a},_renderDownloadTemplate:function(b){var c=this;return a.tmpl(this.options.downloadTemplate,a.map(b,function(a){return c._downloadTemplateHelper(a)}))},_renderDownload:function(b){var c=this._renderDownloadTemplate(b);return c instanceof a?(c.css("display","none"),c.find(".delete button").button({text:!1,icons:{primary:"ui-icon-trash"}}),c.find("a").each(this._enableDragToDesktop),c):a()},_startHandler:function(b){b.preventDefault();var c=a(this).closest(".template-upload"),d=c.data("data");d&&d.submit&&!d.jqXHR&&(d.jqXHR=d.submit(),a(this).fadeOut())},_cancelHandler:function(b){b.preventDefault();var c=a(this).closest(".template-upload"),d=c.data("data")||{};d.jqXHR?d.jqXHR.abort():(d.errorThrown="abort",b.data.fileupload._trigger("fail",b,d))},_deleteHandler:function(b){b.preventDefault();var c=a(this);b.data.fileupload._trigger("destroy",b,{context:c.closest(".template-download"),url:c.attr("data-url"),type:c.attr("data-type"),dataType:b.data.fileupload.options.dataType})},_initEventHandlers:function(){a.blueimp.fileupload.prototype._initEventHandlers.call(this);var b=this.element.find(".files"),c={fileupload:this};b.find(".start button").live("click."+this.options.namespace,c,this._startHandler),b.find(".cancel button").live("click."+this.options.namespace,c,this._cancelHandler),b.find(".delete button").live("click."+this.options.namespace,c,this._deleteHandler)},_destroyEventHandlers:function(){var b=this.element.find(".files");b.find(".start button").die("click."+this.options.namespace),b.find(".cancel button").die("click."+this.options.namespace),b.find(".delete button").die("click."+this.options.namespace),a.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_initFileUploadButtonBar:function(){var b=this.element.find(".fileupload-buttonbar"),c=this.element.find(".files"),d=this.options.namespace;b.addClass("ui-widget-header ui-corner-top"),this.element.find(".fileinput-button").each(function(){var b=a(this).find("input:file").detach();a(this).button({icons:{primary:"ui-icon-plusthick"}}).append(b)}),b.find(".start").button({icons:{primary:"ui-icon-circle-arrow-e"}}).bind("click."+d,function(a){a.preventDefault(),c.find(".start button").click()}),b.find(".cancel").button({icons:{primary:"ui-icon-cancel"}}).bind("click."+d,function(a){a.preventDefault(),c.find(".cancel button").click()}),b.find(".delete").button({icons:{primary:"ui-icon-trash"}}).bind("click."+d,function(a){a.preventDefault(),c.find(".delete button").click()})},_destroyFileUploadButtonBar:function(){this.element.find(".fileupload-buttonbar").removeClass("ui-widget-header ui-corner-top"),this.element.find(".fileinput-button").each(function(){var b=a(this).find("input:file").detach();a(this).button("destroy").append(b)}),this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace).button("destroy")},_enableFileInputButton:function(){this.element.find(".fileinput-button input:file:disabled").each(function(){var b=a(this),c=b.parent();b.detach().prop("disabled",!1),c.button("enable").append(b)})},_disableFileInputButton:function(){this.element.find(".fileinput-button input:file:enabled").each(function(){var b=a(this),c=b.parent();b.detach().prop("disabled",!0),c.button("disable").append(b)})},_initTemplates:function(){this.options.uploadTemplate instanceof a&&!this.options.uploadTemplate.length&&(this.options.uploadTemplate=a(this.options.uploadTemplate.selector)),this.options.downloadTemplate instanceof a&&!this.options.downloadTemplate.length&&(this.options.downloadTemplate=a(this.options.downloadTemplate.selector))},_create:function(){a.blueimp.fileupload.prototype._create.call(this),this._initTemplates(),this.element.addClass("ui-widget"),this._initFileUploadButtonBar(),this.element.find(".fileupload-content").addClass("ui-widget-content ui-corner-bottom"),this.element.find(".fileupload-progressbar").hide().progressbar()},destroy:function(){this.element.find(".fileupload-progressbar").progressbar("destroy"),this.element.find(".fileupload-content").removeClass("ui-widget-content ui-corner-bottom"),this._destroyFileUploadButtonBar(),this.element.removeClass("ui-widget"),a.blueimp.fileupload.prototype.destroy.call(this)},enable:function(){a.blueimp.fileupload.prototype.enable.call(this),this.element.find(":ui-button").not(".fileinput-button").button("enable"),this._enableFileInputButton()},disable:function(){this.element.find(":ui-button").not(".fileinput-button").button("disable"),this._disableFileInputButton(),a.blueimp.fileupload.prototype.disable.call(this)}})}(jQuery);