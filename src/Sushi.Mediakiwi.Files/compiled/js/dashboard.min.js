function isEmpty(a){return null==a||""==a.trim()}function createDate(a,b){var c=a.split("-"),d=b.split(":"),e=parseInt(c[1],10)-1,f=new Date(parseInt(c[2],10),e,parseInt(c[0],10),parseInt(d[0],10),parseInt(d[1],10),0,0);return console.log(f),f}function dateToWcf(a){var b=new Date(a);return isNaN(b)?null:"/Date("+b.getTime()+"-0000)/"}var DashboardCampaign=angular.module("DashboardCampaign",[]);DashboardCampaign.config(function(a,b){a.when("/campaign/:campaign/step/:step",{controller:"Base"}).otherwise({controller:"Base"})}),DashboardCampaign.controller("Base",function(a,b,c,d,e,f,g){nokia.Settings.set("app_id",$("#hereMapsAppID").val()),nokia.Settings.set("app_code",$("#hereMapsAppCode").val()),b.mapContainer=document.getElementById("hereMap"),b.map=new nokia.maps.map.Display(b.mapContainer,{center:[52.009077,4.358321],zoomLevel:12,components:[new nokia.maps.map.component.ZoomBar,new nokia.maps.map.component.Behavior,new nokia.maps.map.component.ZoomRectangle,new nokia.maps.positioning.component.Positioning]}),b.geoFenceContainer=new nokia.maps.map.Container,b.deviceContainer=new nokia.maps.map.Container,b.step=0,b.currentWimUser=parseInt($(".wimUserId").val(),10),b.heartBeat=null,b.currentCampaign,b.charsleft=200,b.campaignTitle="",b.campaignPushMessage="",b.campaignContent="",b.changeState=function(a){0==b.currentCampaign.Key?f.path(""):f.path("campaign/"+b.currentCampaign.Key+"/step/"+a)};var h=new Object;h.currentWimUser=b.currentWimUser,b.campaignChanged=function(){console.log(b.currentCampaign),b.currentCampaign.Key>0?b.currentCampaign.CanSend?b.changeState(2):b.changeState(5):b.changeState(1)},b.ReloadFromCampagneAdd=function(a){f.path("campaign/"+a+"/step/2")},b.$on("$routeChangeSuccess",function(a,d){g.cancel(b.heartBeat),c.post("services/DashBoardService.svc/GetCampaigns",h).success(function(a){var d=[{Value:"",Key:0}];d=d.concat(a.d.Campaigns),b.campaigns=d,null==b.currentCampaign&&(b.step=1,b.currentCampaign=b.campaigns[0]),null==e.step?b.step=1:b.step=e.step;for(var f in b.campaigns){var g=b.campaigns[f];g.Key==e.campaign&&(b.currentCampaign=g)}if(1==b.step&&(b.geoFenceContainer.destroy(),b.deviceContainer.destroy()),2==b.step){b.geoFenceContainer.destroy(),b.deviceContainer.destroy();var h=new Object;h.currentWimUser=b.currentWimUser,h.currentCampaignID=b.currentCampaign.Key,c.post("services/DashBoardService.svc/GetCampaign",h).success(function(a){b.campaign=a.d,b.campaignTitle=a.d.Title,b.campaignPushMessage=a.d.PushMessage,b.campaignContent=a.d.Content,b.titleNotfilledError=!1,b.pushMessageNotfilledError=!1,isEmpty(b.campaign.Title)||isEmpty(b.campaign.PushMessage)?b.step1Class="":b.step1Class="checkmark-1",null!=b.campaign.SelectedFences&&b.campaign.SelectedFences.length>0?b.step2Class="checkmark-1":b.step2Class=""})}if(b.step>=3){b.geoFenceContainer.destroy(),b.deviceContainer.destroy();var h=new Object;h.currentWimUser=b.currentWimUser,h.currentCampaignID=b.currentCampaign.Key,c.post("services/DashBoardService.svc/GetCampaign",h).success(function(a){b.campaign=a.d,b.geoFenceSelected=a.d.GeoFences[0],b.interestSelected=a.d.Interest[0],b.deviceTypeSelected=a.d.DeviceTypes[0],b.identitySelected=a.d.IdentityProviders[0],b.geoFencesNotfilledError=!1,b.DrawPopulation(a.d.DevicePopulation),b.RedrawAllFences(),null!=b.campaign&&(isEmpty(b.campaign.Title)||isEmpty(b.campaign.PushMessage)||(b.step1Class="checkmark-1"),null!=b.campaign.SelectedFences&&b.campaign.SelectedFences.length>0?b.step2Class="checkmark-1":b.step2Class="")})}b.step>1&&b.step<5&&b.populationDisplay(!0)})}),b.populationDisplay=function(a){if(null==b.campaign||1==b.step||5==b.step)return void(b.heartBeat=g(function(){b.populationDisplay(!0)},5e3));var d=new Object;d.currentWimUser=b.currentWimUser,d.currentCampaignID=b.currentCampaign.Key,d.selectedFences=b.campaign.SelectedFences,d.selectedInteresses=b.campaign.SelectedInteresses,d.selectedOS=b.campaign.SelectedDeviceTypes,d.selectIdentityProviders=b.campaign.SelectIdentityProviders,d.maxSpeed=b.campaign.MaximumSpeed,d.maxAge=b.campaign.MaximumAgePosition,c.post("services/DashBoardService.svc/GetPopulation",d).success(function(c){null!=c&&null!=c.d&&(b.campaign.GeoFences.length!=c.d.GeoFences.length&&(b.campaign.GeoFences=c.d.GeoFences,b.geoFenceSelected=c.d.GeoFences[0]),b.campaign.Interest.length!=c.d.Interest.length&&(b.campaign.Interest=c.d.Interest,b.interestSelected=c.d.Interest[0]),b.DrawPopulation(c.d.DevicePopulation)),a&&(b.heartBeat=g(function(){b.populationDisplay(!0)},5e3))})},b.drawAGeoFence=function(a){var c=[];for(var d in a.Coordinates){var e=a.Coordinates[d];c.push(new nokia.maps.geo.Coordinate(e.Longitude,e.Latitude))}var f=new nokia.maps.map.Polygon(c,{pen:{strokeColor:"#00F8",lineWidth:1}});f.geoFenceID=a.Key,b.geoFenceContainer.objects.add(f),b.map.objects.add(b.geoFenceContainer)},b.RedrawAllFences=function(){if(b.geoFenceContainer.destroy(),b.geoFenceContainer=new nokia.maps.map.Container,null!=b.campaign.SelectedFences&&b.campaign.SelectedFences.length>0){for(var a in b.campaign.SelectedFences)for(var c in b.campaign.GeoFences){var d=b.campaign.SelectedFences[a],e=b.campaign.GeoFences[c];d.Key==e.Key&&b.drawAGeoFence(e)}b.map.zoomTo(b.geoFenceContainer.getBoundingBox(),!1,"default")}},b.addToGeoFenceCollection=function(a,c){b.addToCollection(a,c),b.drawAGeoFence(a),b.map.zoomTo(b.geoFenceContainer.getBoundingBox(),!1,"default")},b.removeFromGeoFenceCollection=function(a,c){b.removeFromCollection(a,c),b.RedrawAllFences()},b.addToCollection=function(a,c){if(null!=c){for(var d in c){var e=c[d];if(e.Key==a.Key)return}c.push(a),b.geoFencesNotfilledError=!1,b.populationDisplay(!1)}},b.removeFromCollection=function(a,c){if(null!=c){for(var d in c){var e=c[d];e.Key==a&&(c=c.splice(d,1))}b.populationDisplay(!1)}},b.RedrawPopulation=function(){var a=new Object;a.currentWimUser=b.currentWimUser,a.currentCampaignID=b.currentCampaign.Key,a.selectedFences=b.campaign.SelectedFences,a.selectedInteresses=b.campaign.SelectedInteresses,a.selectedOS=b.campaign.SelectedDeviceTypes,a.selectIdentityProviders=b.campaign.SelectIdentityProviders,a.maxSpeed=b.campaign.MaximumSpeed,a.maxAge=b.campaign.MaximumAgePosition,c.post("services/DashBoardService.svc/SaveRecipientData",a).success(function(a){var d=new Object;d.currentWimUser=b.currentWimUser,d.currentCampaignID=b.currentCampaign.Key,c.post("services/DashBoardService.svc/GetCampaign",d).success(function(a){b.campaign=a.d,b.geoFenceSelected=a.d.GeoFences[0],b.interestSelected=a.d.Interest[0],b.deviceTypeSelected=a.d.DeviceTypes[0],b.identitySelected=a.d.IdentityProviders[0],b.DrawPopulation(a.d.DevicePopulation)})})},b.DrawPopulation=function(a){b.deviceContainer.destroy(),b.deviceContainer=new nokia.maps.map.Container;for(var c in a){var d=a[c],e={latitude:d.Latitude,longitude:d.Longitude};marker=new nokia.maps.map.Marker(e,{icon:d.Icon,anchor:new nokia.maps.util.Point(10,10)}),b.deviceContainer.objects.add(marker)}b.map.objects.add(b.deviceContainer)},b.degradeChars=function(a){null!=b.campaignContent&&(b.charsleft=200-b.campaignContent.length,b.charsleft<=0&&event.preventDefault())},b.saveStep2=function(){var a=0;if(isEmpty(b.campaignTitle)?(a++,b.titleNotfilledError=!0):b.titleNotfilledError=!1,isEmpty(b.campaignPushMessage)?(a++,b.pushMessageNotfilledError=!0):b.pushMessageNotfilledError=!1,0==a){var d=new Object;d.currentWimUser=b.currentWimUser,d.currentCampaignID=b.currentCampaign.Key,d.title=b.campaignTitle,d.pushMessage=b.campaignPushMessage,d.content=b.campaignContent,c.post("services/DashBoardService.svc/SaveMessageData",d).success(function(a){b.changeState(3)})}},b.saveStep3=function(){var a=0;if(null==b.campaign.SelectedFences||b.campaign.SelectedFences.length<1?(a++,b.geoFencesNotfilledError=!0):b.geoFencesNotfilledError=!1,0==a){var d=new Object;d.currentWimUser=b.currentWimUser,d.currentCampaignID=b.currentCampaign.Key,d.selectedFences=b.campaign.SelectedFences,d.selectedInteresses=b.campaign.SelectedInteresses,d.selectedOS=b.campaign.SelectedDeviceTypes,d.selectIdentityProviders=b.campaign.SelectIdentityProviders,d.maxSpeed=b.campaign.MaximumSpeed,d.maxAge=b.campaign.MaximumAgePosition,c.post("services/DashBoardService.svc/SaveRecipientData",d).success(function(a){b.changeState(4)})}},b.saveStep4=function(){if(confirm("Are you sure you want to send the campaign message to "+b.campaign.TotalReach+" persons?")){var a=0,d=null,e=null;if(isEmpty(b.campaign.ExcutionType)?(a++,b.excutionTypeNotfilledError=!0):(b.excutionTypeNotfilledError=!1,"scheduled"==b.campaign.ExcutionType&&(d=createDate(b.campaign.StartDate,b.campaign.StartTime)),"timerange"==b.campaign.ExcutionType&&(d=createDate(b.campaign.StartDate,b.campaign.StartTime),e=createDate(b.campaign.EndDate,b.campaign.EndTime))),0==a){var f=new Object;f.currentWimUser=b.currentWimUser,f.currentCampaignID=b.currentCampaign.Key,f.executeType=b.campaign.ExcutionType,f.startDate=dateToWcf(d),f.endDate=dateToWcf(e),c.post("services/DashBoardService.svc/SendCampaign",f).success(function(a){1==a.d?(b.changeState(5),b.ErrorProcessing=!1):b.ErrorProcessing=!0})}}}});